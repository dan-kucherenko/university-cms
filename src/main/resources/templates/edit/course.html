<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Edit Course</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="../../static/index.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>
<body>
<div class="container-md">
    <form th:object="${course}" onsubmit="editCourse(event)">
        <input type="hidden" th:field="*{courseId}" id="courseId"/>
        <div class="form-group">
            <label for="courseName">Course Name:</label>
            <input type="text" class="form-control" id="courseName" th:field="*{courseName}"/>
        </div>

        <div class="form-group">
            <label for="courseDescription">Course Description:</label>
            <textarea id="courseDescription" class="form-control" th:field="*{courseDescription}"></textarea>
        </div>

        <div class="form-group">
            <label for="department">Department:</label>
            <select id="department" class="form-control" th:field="*{department}">
                <option th:each="dept : ${departments}" th:value="${dept.departmentId}"
                        th:text="${dept.departmentName}">
                    <input type="hidden" id="departmentName" th:value="${dept.departmentName}"/>
                    <input type="hidden" id="departmentSphere" th:value="${dept.departmentSphere}"/>
                </option>
            </select>
        </div>
        <input type="hidden" th:field="*{students}"/>
        <button type="submit" class="btn btn-primary" onsubmit="alert('Course has been successfully edited')">Save
            Changes
        </button>
    </form>
</div>
<script>
    function editCourse() {
        event.preventDefault();
        let students = [];

        $("#students option:selected").each(function () {
            let student = {
                id: $(this).val(),
                username: $(this.username).data("username"),
                firstName: $(this).data("firstName"),
                lastName: $(this).data("lastName"),
                email: $(this).data("email"),
                password: $(this).data("password"),
                phone: $(this).data("phone"),
                role: $(this).data("role"),
                group: $(this).data("group"),
                dateOfBirth: $(this).data("dateOfBirth"),
                yearOfStudy: $(this).data("yearOfStudy"),

            };
            students.push(student);
        });

        let course = {
            courseId: $('#courseId').val(),
            courseName: $('#courseName').val(),
            courseDescription: $('#courseDescription').val(),
            department: {
                departmentId: $('#department').val(),
                departmentName: $('#departmentName').val(),
                departmentSphere: $('#departmentSphere').val()
            },
            students: students
        };

        fetch('http://localhost:8080/courses/edit', {
            method: 'PATCH',
            body: JSON.stringify(course),
            headers: {'Content-type': 'application/json'}
        }).then(response => {
            if (!response.ok && response.status !== 405) {
                throw new Error('Error deleting user.');
            }
            alert("Course has been changed");
            window.location.href = 'http://localhost:8080/courses';
        }).catch(error => {
            alert(error.message);
        });
    }
</script>
</body>
</html>